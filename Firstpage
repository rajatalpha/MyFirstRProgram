library(shiny)
library(shinydashboard)
library(DT)           ##Rendering datatable
library(psych)        ##Summary
library(DataExplorer) ##Categorical Exploration
library(VIM)          ##Missing Value Imputation
library(tidyverse)    ## for %>%
library(ggplot2)

UI <-dashboardPage(
  dashboardHeader(title="Data Exploration"),
  dashboardSidebar(
    sidebarMenu(
      menuItem("Full data",tabName="Data",icon=icon("table"),startExpanded = TRUE,
               fileInput("file","Upload CSV files",multiple=TRUE,accept=("text/comma")),
               selectInput("select", "Select Variable","None", "placeholder 1",multiple = TRUE),
               actionButton(inputId = "Go",label = "Go")
      ),
      menuItem("Continous variables",tabName="Continous Variables",icon=icon("table"),
               selectInput(inputId = "Contvariable",
                           label = "Select Variable",
                           choices="",selected=""
               ),
               # button
               actionButton(inputId = "GoCON",label = "Go")
      ),
      menuItem("Categorical variables",tabName="Categorical variables",icon=icon("table"),
               selectInput(inputId = "Catvariable",
                           label = "Select Variable",
                           choices="",selected=""
               ),
               actionButton(inputId = "GoCAT",label = "Go")
      )
    )
  ),
  dashboardBody(
    tabsetPanel(
      tabPanel("Data",
               tabItem(tabName="Data",
                       fluidRow(
                         h2('A brief Look into the Datset'),
                         DT::dataTableOutput("data.frame"),
                         h2('Basic Summary'),
                         infoBoxOutput("Ro"),
                         infoBoxOutput("Co"),
                         infoBoxOutput("Mi"),
                         infoBoxOutput("No"),
                         infoBoxOutput("DCON"),
                         infoBoxOutput("DCAT")),
                       fluidRow(
                         h2('Visualizing Missing Data'),
                         plotOutput("miss") 
                       ),
                       fluidRow(
                         h4("Subsetted Dataset"),
                         DT::dataTableOutput("data.frame2"),
                         h4("Structure of Dataset"),
                         verbatimTextOutput("struct"),
                         h4("Summary of dataset"),
                         verbatimTextOutput("Summary")))), #end of 1st tab panel
      tabPanel("Continous variable",
               tabItem(tabName = "Continous Variables",
                       fluidRow(
                         h2("Exploring Continous Variable"),
                         infoBoxOutput("Sel"),
                         infoBoxOutput("Nmiss"),
                         infoBoxOutput("NonMiss")),
                       fluidRow(
                         box(
                           sliderInput("slider1", "Slider input:", 0, 100, 2)
                         ),
                         box(
                           sliderInput("slider2", "Slider input:", 1, 100,2)
                         )
                       ),
                       fluidRow(
                         box(plotOutput("histc")),
                         box(plotOutput("histy"))
                       ))
      ),  # end of second tab panel
      tabPanel("Categorical variable",
               tabItem(tabName = "Categorical Variables",h2("Exploring Categorical Variable"),
                       fluidRow(
                         infoBoxOutput("Selc"),
                         infoBoxOutput("Nmissc"),
                         infoBoxOutput("NonMissc"),
                         verbatimTextOutput("Truetable")),
                       fluidRow(
                         box(
                           plotOutput("bart") 
                         )
                       ))#end of tab item
      )  # end Of last tabpanel
    ) # end Of tabsetpanel
  )         #Dashboard Body
)         ###End of Dashboard page

server<-shinyServer(function(input,output,session){
  values <- reactiveValues(df_data = NULL)
  
  observeEvent(input$file, {
    values$df_data <- read.csv(input$file$datapath)
    
    output$data.frame <-DT::renderDataTable(values$df_data)
    
    output$struct<-renderPrint({
      df <- values$df_data
      str(df)
    })
    
    output$Summary<-renderPrint({
      df <- values$df_data
      describe(df)})
  })
  ## update 'columns' selector
  observeEvent(input$file, {
    updateSelectInput(session, "select", choices = names(values$df_data))
    updateSelectInput(session, "Contvariable", choices = names(values$df_data[ ,!sapply(values$df_data, is.factor)]))
    updateSelectInput(session, "Catvariable", choices = names(values$df_data[,sapply(values$df_data, is.factor)]))
    output$Ro <- renderInfoBox({
      infoBox(
        "Row Count", paste0(nrow(values$df_data)), icon = icon("list"),
        color = "blue",fill=TRUE
      )
    })
    output$Co <- renderInfoBox({
      infoBox(
        "Column Count", paste0(ncol(values$df_data)), icon = icon("list"),
        color = "orange",fill=TRUE
      )
    })
    output$Mi <- renderInfoBox({
      infoBox(
        "Missing Values", paste0(sum(is.na(values$df_data))), icon = icon("list"),
        color = "red",fill=TRUE
      )
    }) 
    output$No <- renderInfoBox({
      infoBox(
        "Non missing values", paste0(unname(table(is.na(values$df_data))[1])), 
        icon = icon("thumbs-up",lib="glyphicon"),
        color = "olive",fill=TRUE
      )
    })
    output$DCON <- renderInfoBox({
      infoBox(
        "Continuous Columns Count", paste0(ncol(values$df_data[ ,!sapply(values$df_data, is.factor)])), icon = icon("list"),
        color = "maroon",fill=TRUE
      )
    })
    output$DCAT <- renderInfoBox({
      infoBox(
        "Categorical Column Count", paste0(ncol(values$df_data[ ,sapply(values$df_data, is.factor)])), icon = icon("list"),
        color = "purple",fill=TRUE
      )
    })
    output$miss<-renderPlot({
      df <- values$df_data
      aggr(df, numbers = TRUE, prop = c(TRUE, FALSE))
    }) 
  })
  
  observeEvent(input$Go, {
    output$data.frame2 <- DT::renderDataTable({
      subset_table <- values$df_data[, input$select, drop = F]
      datatable(subset_table)
    })
  })
  
  observeEvent(input$GoCON, {
    output$Sel <- renderInfoBox({
      infoBox(
        "Selected Variable", paste0(input$Contvariable),icon = icon("thumbs-up",lib="glyphicon"),
        color = "blue"
      )
    })
    output$Nmiss <- renderInfoBox({
      infoBox(
        "Missing values", paste0(colSums(is.na(values$df_data%>% select(input$Contvariable)))), 
        icon = icon("list"),
        color = "red",fill=TRUE
      )
    })
    output$NonMiss <- renderInfoBox({
      infoBox(
        " Non Missing Values", paste0(colSums(!is.na(values$df_data%>% select(input$Contvariable)))), icon = icon("list"),
        color = "olive",fill=TRUE
      )
    })  
    output$summary <- renderPrint({
      df <- values$df_data
      df <- df[,input$Contvariable]
      describe(df) 
    })
    output$histc<-renderPlot({
      df <- values$df_data
      pf <- df[,input$Contvariable]
      ggplot(data=df, aes(x=pf)) + 
        geom_histogram(color="grey", fill="darkgrey",bins=input$slider1) +
        geom_freqpoly(bins = input$slider1) + xlab(input$Contvariable) + ggtitle(paste("Histogram with Frequency Polygon of ",input$Contvariable)) +
        geom_vline(aes(xintercept=mean(pf),
                       color="red", linetype="continuous", size=0.5))
    })
    output$histy<-renderPlot({
      df <- values$df_data
      gf <- df[,input$Contvariable]
      ggplot(data=df, aes(x=gf))+ geom_histogram(aes(y=..density..), colour="black", fill="white",bins=input$slider2) + geom_density(alpha=.2, fill="#FF6666") + xlab(input$Contvariable) + ggtitle(paste("Density Plot of",input$Contvariable))  
    })   
    
  })
  observeEvent(input$GoCAT, {
    
    output$Selc <- renderInfoBox({
      infoBox(
        "Selected Variable", paste0(input$Catvariable), icon = icon ("thumbs-up",lib="glyphicon"),
        color = "blue",fill=TRUE
      )
    })
    output$Nmissc <- renderInfoBox({
      infoBox(
        "Missing values", paste0(colSums(is.na(values$df_data%>% select(input$Catvariable)))),
        icon = icon("list"),
        color = "red",fill=TRUE
      )
    })
    output$NonMissc <- renderInfoBox({
      infoBox(
        "Non Missing values", paste0(colSums(!is.na(values$df_data%>% select(input$Catvariable)))),icon = icon("list"),
        color = "olive",fill=TRUE
      )
    })
    output$Truetable <- renderPrint({
      df <- values$df_data
      df <- df[,input$Catvariable]
      table(df) 
    })
    output$bart<- renderPlot({
      df <- values$df_data
      tf <- df[,input$Catvariable]
      ggplot(df, aes(tf)) +
        geom_bar(stat="count") + labs(title=paste("Barplot of ",input$Catvariable)) + xlab(input$Catvariable)
    })
  })
  
})
shinyApp(UI, server)

